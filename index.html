<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College Football Picks - Season Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .drop-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .nav-button {
            transition: all 0.3s ease;
        }
        .nav-button.active {
            background-color: #3b82f6;
            color: white;
        }
    </style>
</head>
<body>
    <div id="root">
        <!-- Upload Screen -->
        <div id="upload-screen" class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-xl shadow-lg p-8 text-center">
                    <div class="mb-6">
                        <div class="w-16 h-16 mx-auto mb-4 bg-yellow-500 rounded-full flex items-center justify-center">
                            <span class="text-white text-2xl font-bold">üèÜ</span>
                        </div>
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">
                            College Football Season Dashboard
                        </h1>
                        <p class="text-gray-600">Upload your weekly picks CSV to generate live standings</p>
                    </div>

                    <!-- Existing Weeks -->
                    <div id="existing-weeks" style="display: none;" class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Current Season:</h3>
                        <div id="weeks-list" class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4"></div>
                        <div class="flex gap-2 justify-center">
                            <button onclick="viewDashboard()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                View Dashboard
                            </button>
                            <button onclick="resetAll()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                                Reset Season
                            </button>
                        </div>
                    </div>

                    <!-- Upload Zone -->
                    <div id="drop-zone" class="drop-zone" onclick="document.getElementById('file-input').click()">
                        <div id="upload-content">
                            <div class="w-12 h-12 mx-auto mb-4 bg-gray-400 rounded-full flex items-center justify-center">
                                <span class="text-white text-xl">üìÅ</span>
                            </div>
                            <p class="text-lg font-semibold text-gray-700 mb-2">
                                <span id="upload-text">Drop Week 1 CSV file here</span>
                            </p>
                            <p class="text-gray-500 mb-4">or click to browse</p>
                        </div>
                        <div id="loading-content" style="display: none;">
                            <div class="w-12 h-12 mx-auto mb-4">
                                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                            </div>
                            <p>Processing your picks...</p>
                        </div>
                    </div>

                    <input type="file" id="file-input" accept=".csv" style="display: none;">

                    <div id="error-message" style="display: none;" class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                        <p class="text-red-700" id="error-text"></p>
                    </div>

                    <div class="mt-8 text-left">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">How to use:</h3>
                        <ol class="list-decimal list-inside space-y-2 text-gray-600">
                            <li>Upload Week 1 CSV from your Google Form responses</li>
                            <li>Continue uploading each week's CSV as the season progresses</li>
                            <li>View comprehensive analytics and standings</li>
                            <li>Export and share data with your league</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div id="dashboard-screen" style="display: none;" class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
            <div class="max-w-7xl mx-auto">
                <!-- Header -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
                                <span class="text-yellow-500 text-4xl">üèÜ</span>
                                CFB Season Dashboard
                            </h1>
                            <p class="text-gray-600 mt-2" id="season-info">Season overview</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="addNewWeek()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Add New Week
                            </button>
                            <button onclick="exportData()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                Export Data
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="bg-white rounded-xl shadow-lg p-4 mb-6">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="showView('season-total')" class="nav-button px-4 py-2 rounded-lg bg-blue-600 text-white font-medium" id="nav-season-total">
                            üìä Season Totals
                        </button>
                        <button onclick="showView('weekly-breakdown')" class="nav-button px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 font-medium" id="nav-weekly">
                            üìÖ Weekly Breakdown  
                        </button>
                    </div>
                </div>

                <!-- Season Total View -->
                <div id="season-total-view">
                    <!-- Quick Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white rounded-lg shadow-md p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">Season Leader</p>
                                    <p class="text-lg font-bold text-gray-800" id="season-leader-name">-</p>
                                    <p class="text-sm text-green-600" id="season-leader-points">- points</p>
                                </div>
                                <span class="text-yellow-500 text-3xl">üëë</span>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-md p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">Weeks Played</p>
                                    <p class="text-2xl font-bold text-gray-800" id="weeks-played">-</p>
                                </div>
                                <span class="text-blue-500 text-3xl">üìÖ</span>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow-md p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">Total Players</p>
                                    <p class="text-2xl font-bold text-gray-800" id="total-players">-</p>
                                </div>
                                <span class="text-purple-500 text-3xl">üë•</span>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow-md p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">Season Avg</p>
                                    <p class="text-2xl font-bold text-gray-800" id="season-avg">-</p>
                                </div>
                                <span class="text-indigo-500 text-3xl">üéØ</span>
                            </div>
                        </div>
                    </div>

                    <!-- Season Standings Table -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="p-6 border-b border-gray-200">
                            <h2 class="text-2xl font-bold text-gray-800">Season Standings</h2>
                            <p class="text-gray-600">Cumulative points across all weeks</p>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase">Rank</th>
                                        <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase">Player</th>
                                        <th class="px-6 py-4 text-center text-sm font-medium text-gray-500 uppercase">Total Points</th>
                                        <th class="px-6 py-4 text-center text-sm font-medium text-gray-500 uppercase">Weeks</th>
                                        <th class="px-6 py-4 text-center text-sm font-medium text-gray-500 uppercase">Weekly Avg</th>
                                    </tr>
                                </thead>
                                <tbody id="season-standings-table" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Weekly Breakdown View -->
                <div id="weekly-breakdown-view" style="display: none;">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Weekly Performance</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr id="weekly-header">
                                        <th class="px-4 py-3 text-left font-medium text-gray-500">Player</th>
                                    </tr>
                                </thead>
                                <tbody id="weekly-breakdown-table">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let seasonData = { weeks: [], players: {}, games: {} };

        // Initialize
        window.addEventListener('load', function() {
            loadData();
            setupEventListeners();
        });

        function loadData() {
            try {
                const savedData = localStorage.getItem('cfb-season-data');
                if (savedData) {
                    seasonData = JSON.parse(savedData);
                    if (!seasonData.weeks) seasonData.weeks = [];
                    if (!seasonData.players) seasonData.players = {};
                    if (!seasonData.games) seasonData.games = {};
                    
                    if (seasonData.weeks.length > 0) {
                        showExistingWeeks();
                    }
                }
                updateUploadText();
            } catch (error) {
                console.error('Error loading data:', error);
                seasonData = { weeks: [], players: {}, games: {} };
            }
        }

        function saveData() {
            try {
                localStorage.setItem('cfb-season-data', JSON.stringify(seasonData));
                console.log('Data saved successfully');
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }

        function setupEventListeners() {
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');

            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });

            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });
        }

        function handleFileUpload(file) {
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showError('Please upload a CSV file');
                return;
            }

            showLoading();
            hideError();

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    const weekData = processCSVData(csvText);
                    addWeekToSeason(weekData);
                    saveData();
                    showDashboard();
                    hideLoading();
                } catch (err) {
                    console.error('Processing error:', err);
                    showError('Failed to process CSV: ' + err.message);
                    hideLoading();
                }
            };
            reader.readAsText(file);
        }

        function processCSVData(csvText) {
            const parsed = Papa.parse(csvText, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true
            });

            const participants = parsed.data.filter(row => row['Email Address']);
            const games = [];
            
            // Extract games
            const headers = parsed.meta.fields;
            const gameHeaders = headers.filter(h => h && h.includes(' at ') && h.includes('('));
            
            gameHeaders.forEach(header => {
                if (header.includes('+') || header.includes('-')) {
                    const gameKey = header.split('(')[0].trim();
                    games.push({
                        name: gameKey,
                        type: 'spread',
                        column: header
                    });
                }
            });
            
            const standings = participants.map(participant => {
                const email = participant['Email Address'];
                const name = email.split('@')[0];
                
                let totalPoints = 0;
                let gamesPlayed = 0;
                const picks = {};
                
                // Extract picks
                games.forEach(game => {
                    if (participant[game.column]) {
                        picks[game.name] = participant[game.column];
                    }
                });
                
                // Count points
                Object.keys(participant).forEach(key => {
                    if (key.startsWith('Column') && typeof participant[key] === 'number') {
                        gamesPlayed++;
                    }
                });
                
                // Get total points
                const lastCol = Object.keys(participant).pop();
                if (typeof participant[lastCol] === 'number' && participant[lastCol] > 0) {
                    totalPoints = participant[lastCol];
                } else {
                    Object.keys(participant).forEach(key => {
                        if (key.startsWith('Column') && typeof participant[key] === 'number') {
                            totalPoints += participant[key];
                        }
                    });
                }
                
                return {
                    name: name,
                    email: email,
                    totalPoints: totalPoints,
                    gamesPlayed: gamesPlayed,
                    picks: picks
                };
            });

            standings.sort((a, b) => b.totalPoints - a.totalPoints);
            
            return { players: standings, games: games };
        }

        function addWeekToSeason(weekData) {
            seasonData.weeks.push(weekData);
            
            // Update player totals
            weekData.players.forEach(player => {
                if (!seasonData.players[player.name]) {
                    seasonData.players[player.name] = {
                        name: player.name,
                        email: player.email,
                        weeklyScores: [],
                        totalPoints: 0,
                        totalGames: 0
                    };
                }
                
                seasonData.players[player.name].weeklyScores.push(player.totalPoints);
                seasonData.players[player.name].totalPoints += player.totalPoints;
                seasonData.players[player.name].totalGames += player.gamesPlayed;
            });

            showExistingWeeks();
        }

        function showExistingWeeks() {
            if (seasonData.weeks.length > 0) {
                document.getElementById('existing-weeks').style.display = 'block';
                const weeksList = document.getElementById('weeks-list');
                weeksList.innerHTML = '';
                
                seasonData.weeks.forEach((week, index) => {
                    const weekCard = document.createElement('div');
                    weekCard.className = 'bg-blue-100 rounded-lg p-2 text-center';
                    weekCard.innerHTML = `
                        <div class="font-semibold text-blue-800">Week ${index + 1}</div>
                        <div class="text-xs text-blue-600">${week.players ? week.players.length : 0} players</div>
                    `;
                    weeksList.appendChild(weekCard);
                });
            }
            updateUploadText();
        }

        function updateUploadText() {
            const nextWeek = seasonData.weeks.length + 1;
            document.getElementById('upload-text').textContent = `Drop Week ${nextWeek} CSV file here`;
        }

        function showLoading() {
            document.getElementById('upload-content').style.display = 'none';
            document.getElementById('loading-content').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('upload-content').style.display = 'block';
            document.getElementById('loading-content').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('error-text').textContent = message;
        }

        function hideError() {
            document.getElementById('error-message').style.display = 'none';
        }

        function addNewWeek() {
            document.getElementById('upload-screen').style.display = 'block';
            document.getElementById('dashboard-screen').style.display = 'none';
            document.getElementById('file-input').value = '';
            hideError();
            hideLoading();
        }

        function viewDashboard() {
            showDashboard();
        }

        function showDashboard() {
            document.getElementById('upload-screen').style.display = 'none';
            document.getElementById('dashboard-screen').style.display = 'block';
            renderDashboard();
        }

        function renderDashboard() {
            const players = Object.values(seasonData.players || {});
            const weeksCount = (seasonData.weeks || []).length;

            document.getElementById('season-info').textContent = 
                `${weeksCount} weeks ‚Ä¢ ${players.length} players`;

            showView('season-total');
        }

        function showView(viewName) {
            // Hide all views
            document.getElementById('season-total-view').style.display = 'none';
            document.getElementById('weekly-breakdown-view').style.display = 'none';
            
            // Remove active class
            document.getElementById('nav-season-total').classList.remove('active');
            document.getElementById('nav-weekly').classList.remove('active');
            
            // Show selected view
            document.getElementById(viewName + '-view').style.display = 'block';
            document.getElementById('nav-' + viewName.replace('-breakdown', '')).classList.add('active');
            
            // Set button colors
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.className = 'nav-button px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 font-medium';
            });
            document.getElementById('nav-' + viewName.replace('-breakdown', '')).className = 
                'nav-button px-4 py-2 rounded-lg bg-blue-600 text-white font-medium active';

            if (viewName === 'season-total') {
                renderSeasonTotal();
            } else if (viewName === 'weekly-breakdown') {
                renderWeeklyBreakdown();
            }
        }

        function renderSeasonTotal() {
            const players = Object.values(seasonData.players || {});
            players.sort((a, b) => (b.totalPoints || 0) - (a.totalPoints || 0));
            
            const weeksCount = (seasonData.weeks || []).length;
            const leader = players[0];
            const avgScore = players.length > 0 ? 
                (players.reduce((sum, p) => sum + (p.totalPoints || 0), 0) / players.length).toFixed(1) : 0;

            // Update stats
            document.getElementById('season-leader-name').textContent = leader?.name || 'N/A';
            document.getElementById('season-leader-points').textContent = `${leader?.totalPoints || 0} points`;
            document.getElementById('weeks-played').textContent = weeksCount;
            document.getElementById('total-players').textContent = players.length;
            document.getElementById('season-avg').textContent = avgScore;

            // Render table
            const tableBody = document.getElementById('season-standings-table');
            tableBody.innerHTML = '';

            if (players.length === 0) {
                tableBody.innerHTML = `
                    <tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">
                        No season data available. Upload your first week to get started!
                    </td></tr>
                `;
                return;
            }

            players.forEach((player, index) => {
                const weeklyAvg = weeksCount > 0 ? ((player.totalPoints || 0) / weeksCount).toFixed(1) : 0;
                
                const row = document.createElement('tr');
                row.className = `hover:bg-gray-50 ${index < 3 ? 'bg-yellow-50' : ''}`;
                
                row.innerHTML = `
                    <td class="px-6 py-4">
                        ${index === 0 ? 'üèÜ' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : (index + 1)}
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm">
                                ${(player.name || 'U')[0].toUpperCase()}
                            </div>
                            <div class="ml-3 font-medium">${player.name || 'Unknown'}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <div class="text-lg font-bold">${player.totalPoints || 0}</div>
                        ${index === 0 ? '<div class="text-xs text-yellow-600">LEADER</div>' : ''}
                    </td>
                    <td class="px-6 py-4 text-center">${weeksCount}</td>
                    <td class="px-6 py-4 text-center font-medium">${weeklyAvg}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function renderWeeklyBreakdown() {
            const players = Object.values(seasonData.players || {});
            const weeksCount = (seasonData.weeks || []).length;
            
            // Build header
            const header = document.getElementById('weekly-header');
            header.innerHTML = '<th class="px-4 py-3 text-left font-medium text-gray-500">Player</th>';
            for (let i = 1; i <= weeksCount; i++) {
                header.innerHTML += `<th class="px-3 py-3 text-center font-medium text-gray-500">W${i}</th>`;
            }
            header.innerHTML += '<th class="px-4 py-3 text-center font-medium text-gray-500">Total</th>';

            // Build rows
            const tableBody = document.getElementById('weekly-breakdown-table');
            tableBody.innerHTML = '';

            players.sort((a, b) => (b.totalPoints || 0) - (a.totalPoints || 0));

            players.forEach((player, index) => {
                const row = document.createElement('tr');
                row.className = `hover:bg-gray-50 ${index < 3 ? 'bg-yellow-50' : ''}`;
                
                let rowHTML = `
                    <td class="px-4 py-3">
                        <div class="flex items-center">
                            <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs font-bold">
                                ${(player.name || 'U')[0].toUpperCase()}
                            </div>
                            <div class="ml-2 font-medium">${player.name || 'Unknown'}</div>
                        </div>
                    </td>`;

                for (let i = 0; i < weeksCount; i++) {
                    const score = (player.weeklyScores && player.weeklyScores[i]) || '-';
                    rowHTML += `<td class="px-3 py-3 text-center text-sm">${score}</td>`;
                }

                rowHTML += `<td class="px-4 py-3 text-center font-bold">${player.totalPoints || 0}</td>`;
                
                row.innerHTML = rowHTML;
                tableBody.appendChild(row);
            });
        }

        function resetAll() {
            if (confirm('Are you sure you want to reset the entire season? This will delete all uploaded data.')) {
                seasonData = { weeks: [], players: {}, games: {} };
                localStorage.removeItem('cfb-season-data');
                document.getElementById('existing-weeks').style.display = 'none';
                updateUploadText();
                console.log('Season reset completed');
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(seasonData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `cfb-season-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }
    </script>
</body>
</html>
